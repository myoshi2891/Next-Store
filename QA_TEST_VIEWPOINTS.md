# QAテスト観点（厳しめ）- Next.js Store

## 目的
- 金銭・個人情報・在庫・注文データの整合性を最優先で保証する
- 認証・認可・決済・画像アップロードの失敗時に安全側へ倒す
- UI/UX、性能、運用性まで含めて「壊れにくさ」を担保する

## 対象範囲
- 公開ページ: トップ、商品一覧、商品詳細、About
- 認証必須: カート、チェックアウト、注文履歴、レビュー、Favorites
- 管理画面: 商品管理、売上一覧
- 依存サービス: Clerk、Stripe、Supabase、PostgreSQL/Prisma

## 重要度の目安
- P0: 決済・注文・認証漏れ・個人情報漏洩・権限逸脱
- P1: カート計算、価格表示、データ整合、レビュー/お気に入り破損
- P2: UX劣化、見た目崩れ、軽微な性能低下

## 認証・認可
- 未ログインで保護ルートへアクセスした時の遷移/表示
- 管理画面に一般ユーザーが直接URLアクセスした際の遮断
- ADMIN_USER_ID 不一致時の挙動（環境変数未設定含む）
- セッション切れ/ログアウト直後の操作継続（多タブ含む）
- 保護API（/api/payment, /api/confirm）を未認証で直接叩いた場合

## 商品一覧・検索・表示
- 検索条件（大小文字・部分一致・特殊文字）の一致/不一致
- 検索パラメータの無効値（空/長すぎ/記号だらけ）
- レイアウト切替（grid/list）とURLパラメータの整合
- 0件時の文言・導線・レイアウト崩れ
- 価格/通貨フォーマットの桁/丸め/言語設定

## 商品詳細
- 存在しない商品IDの遷移/リダイレクト
- 商品データ欠損時（画像/説明/会社名）の表示
- 画像読み込み失敗時のフォールバック
- シェア機能/パンくず/評価表示の整合

## お気に入り（Favorites）
- 連打/多タブでの二重登録・二重削除の発生有無
- 自分以外のFavorite ID操作（パラメータ改ざん）
- 商品削除後のお気に入り一覧の整合性
- 失敗時のUIフィードバック（トースト/ボタン状態）

## レビュー
- 評点境界（1/5）・整数以外・空/長すぎコメント
- 同一ユーザーの重複レビュー可否（想定仕様の確認）
- XSS/HTML注入（コメント/作者名）と表示サニタイズ
- レビュー削除の権限チェック（自分以外を削除できない）
- 商品削除時のレビューのカスケード削除

## カート
- 追加数量の境界（0、負数、極端な大きさ）
- 既存商品への再追加で数量が正しく加算されるか
- 数量変更/削除の即時反映と合計の再計算
- 空カート時の送料/税/合計の扱い
- 価格変更がカート合計に反映されるタイミング
- 同一アカウント複数端末での競合更新

## 注文作成〜決済
- カート空で注文作成ができないこと
- 注文作成時の未払い注文削除ロジックの影響（多タブ）
- /checkout の orderId/cartId 欠落時の挙動
- /api/payment の 404/500 時のリカバリUI
- Stripe決済キャンセル/失敗/タイムアウト時の状態遷移
- /api/confirm の二重呼び出し・リトライ時の冪等性
- 決済成功だがconfirm失敗時の不整合（注文未Paid/カート削除）
- 決済金額と注文金額の一致（改ざん耐性）

## 注文履歴
- 支払い済みのみ表示されること
- 直近注文の反映遅延（キャッシュ/再検証）
- 注文総額/税/送料の表示整合

## 管理画面（商品管理・売上）
- 管理者以外のアクセス遮断とリダイレクト先
- 商品作成: 必須項目/文字数/価格/説明文語数の境界
- 画像アップロード失敗時のロールバック（DB/ストレージ）
- 商品編集: 変更反映/画像差し替え/再検証
- 商品削除: 関連データ（お気に入り/レビュー/カート）への影響
- 売上一覧: 件数表示/並び順/日付フォーマット/金額表示

## 画像アップロード（Supabase）
- 1MB超過・0バイト・MIME偽装の拒否
- 同名/同時アップロード時の衝突（timestamp命名）
- 削除時のURL形式不正・二重削除の扱い
- 署名URL/公開URLの有効性とキャッシュ

## データ整合性・計算ロジック
- 税率/送料/合計の計算式と丸めの一致
- カート内商品削除後の合計再計算の精度
- 価格がint前提であることの境界（小数/通貨差異）
- Prismaカスケード削除の有効性（DBレベル）

## エラーハンドリング/リカバリ
- サーバーアクション失敗時のメッセージ表示
- ネットワーク断/タイムアウト時のUI状態（ボタン無限ローディング等）
- 404/500/リダイレクトの統一挙動
- 例外ログがユーザーに漏れないこと

## セキュリティ
- パラメータ改ざん（productId/cartId/orderId）での権限逸脱
- CSRF/リプレイ（フォーム/サーバーアクション）の耐性
- 画像/レビュー/検索へのインジェクション
- 秘密鍵/環境変数の漏洩（クライアントバンドル）

## パフォーマンス/スケール
- 大量商品（1万件想定）での一覧/検索の応答
- 画像最適化の効果（LCP/CLS/帯域）
- Stripe埋め込みの読み込み遅延時のUX
- Server Actionsの連続呼び出し負荷

## 互換性/レスポンシブ/アクセシビリティ
- 主要ブラウザ/モバイルでの表示・操作
- キーボード操作/フォーカス/Tab順序
- 入力フォームのラベル/エラー表示/通知の読み上げ
- ダークモードの配色コントラスト

## 依存サービス障害・運用
- Clerk/Stripe/Supabase障害時のユーザー導線
- DB接続断/遅延時の挙動
- 監視・ログで原因追跡できること
- 環境変数未設定時の安全な失敗
