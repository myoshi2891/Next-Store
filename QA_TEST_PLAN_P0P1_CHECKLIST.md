# QAテスト計画（P0/P1合意・チェックリスト・依存サービス障害）

## 1. P0/P1の合意（運用優先度の確定）

### 合意の前提
- P0: 収益/個人情報/権限に関わる致命的障害。即時ブロック/リリース停止対象
- P1: 主要機能の不成立やデータ不整合。リリース可否に直結
- P2以下: 回避策あり/軽微。計画修正で対応可

### P0合意対象（必ず潰す）
- 認証/認可バイパスで保護ページ・管理画面に侵入可能
- 決済成功/失敗に関わらず注文状態が誤更新される
- 他ユーザーの注文/カート/レビュー/お気に入りが参照・変更可能
- 決済金額/注文金額が一致せず改ざん可能
- 画像アップロードで任意ファイル実行・不正公開が可能
- 環境変数/秘密鍵がクライアントに露出
- 注文確定後のカート削除/保持が不整合で二重課金や欠品が発生

### P1合意対象（優先修正）
- カート計算（税/送料/合計）が誤算・二重計算される
- 商品作成/編集/削除の失敗時にDBとストレージが不整合
- レビュー/お気に入りの二重登録・削除の競合が起きる
- 未ログイン/セッション切れ時に操作が破綻しUIがフリーズ
- 商品一覧/検索で結果が漏れ/欠落する
- 決済画面が表示されない/復帰不能（依存サービスOK時）

### P0/P1判定のための確認事項
- 影響範囲: 収益/個人情報/権限/在庫/注文
- 再現性: 1手で再現 vs 特定条件のみ
- 回避策: ある/ない（ない場合は優先度を上げる）
- 発生頻度: 高頻度か、特定ユーザーのみか

## 2. 観点からのテストケース/チェックリスト

### 認証・認可（P0/P1）
- P0: 未ログインで保護ルートアクセス時の強制リダイレクト
- P0: 一般ユーザーが `/admin/*` を直打ちしてもアクセス不可
- P0: `ADMIN_USER_ID` 未設定時に管理画面が露出しない
- P1: セッション切れ/多タブでの操作継続時に安全に失敗する
- P1: `/api/payment` `/api/confirm` の未認証アクセスが拒否される

### 商品一覧・検索（P1）
- P1: 検索パラメータ（空/長すぎ/記号）で500にならない
- P1: 大小文字・部分一致で期待通りの検索結果になる
- P1: layout切替時にURLパラメータが保持される

### 商品詳細（P1）
- P1: 存在しない商品IDで安全にリダイレクトされる
- P1: 画像欠損/読み込み失敗時のフォールバック表示
- P1: 価格/説明文/会社名の欠損時に破綻しない

### お気に入り（P1）
- P1: 連打/多タブで二重登録・削除が起きない
- P1: 他人のFavorite IDを指定しても操作不可
- P1: 商品削除後の一覧表示が破綻しない

### レビュー（P1）
- P1: rating境界（1/5）と整数以外入力の拒否
- P1: コメントの最小/最大長、空入力の拒否
- P1: 自分以外のレビュー削除が不可
- P1: 文字列にHTML/JSを含めても表示が安全

### カート（P0/P1）
- P0: カートID改ざんで他人のカート操作が不可
- P1: 追加数量の境界（0/負数/極端な数）を拒否
- P1: 追加・削除・数量変更で合計が即時再計算される
- P1: 空カートで送料/税が0になる

### 注文/決済（P0/P1）
- P0: 決済成功時のみ注文がPaidになる
- P0: `orderId` `cartId` 改ざんで他人の注文を更新できない
- P0: 決済金額が注文金額と一致しない場合は失敗する
- P1: `/checkout` にパラメータ欠落時、適切にエラー/誘導する
- P1: Stripeキャンセル/失敗後に注文・カートが壊れない
- P1: `/api/confirm` の多重実行で二重更新されない

### 管理画面（P0/P1）
- P0: 管理画面へ一般ユーザーがアクセス不可
- P1: 商品作成時のバリデーション（価格/説明/画像サイズ）
- P1: 画像更新失敗時にDB/ストレージが不整合にならない
- P1: 商品削除時に関連データが適切に削除される

### エラーハンドリング/UX（P1）
- P1: サーバーアクション失敗時にユーザーへ通知される
- P1: 404/500時の導線が破綻しない
- P1: ネットワーク断でローディングが固着しない

## 3. 依存サービス障害のテスト計画

### Clerk（認証）
- 障害想定: ログイン/セッション取得不可、レート制限
- 期待挙動:
  - 保護ページはアクセス不可になり安全側へリダイレクト
  - UIに再試行/問い合わせ導線を表示
- テスト方法:
  - Clerk SDKを無効化/環境変数をダミーに変更
  - 通信遮断（ローカルでエンドポイントDNSを落とす）

### Stripe（決済）
- 障害想定: セッション作成失敗、confirm取得失敗、タイムアウト
- 期待挙動:
  - 決済画面の再試行が可能
  - 注文はPaidにならない、カートは残る
  - エラー内容がユーザーに過度に露出しない
- テスト方法:
  - `STRIPE_SECRET_KEY` を無効化
  - `/api/payment` を意図的に500にしてUI確認
  - Stripeのテストカードで失敗/キャンセルを再現

### Supabase（画像アップロード）
- 障害想定: アップロード失敗、削除失敗、ストレージ遅延
- 期待挙動:
  - 商品作成/更新は失敗し、DBに不完全なデータを残さない
  - UIに明確なエラー表示
- テスト方法:
  - `SUPABASE_URL` `SUPABASE_KEY` を無効化
  - 大容量/不正MIMEのファイルを投入

### PostgreSQL/Prisma（DB）
- 障害想定: 接続断、タイムアウト、整合性制約エラー
- 期待挙動:
  - 500にならず、ユーザーに安全なメッセージ
  - サーバー側ログに詳細が残る
- テスト方法:
  - DB停止/接続先変更
  - 制約違反のデータを投入して挙動確認

## 4. 進め方（運用）
- P0/P1の合意後、P0を先行で自動/手動テスト化
- 各P1はリリース前の回帰チェックリストとして固定化
- 依存サービス障害はリリース前に最低1回実施
